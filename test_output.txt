============================= test session starts =============================
platform win32 -- Python 3.12.10, pytest-8.4.1, pluggy-1.6.0
rootdir: C:\codex\databarn
plugins: anyio-4.10.0, typeguard-4.4.4
collected 1 item

tests\test_funcs.py F                                                    [100%]

================================== FAILURES ===================================
_________________________ test_dict_to_cob_with_model _________________________

    def test_dict_to_cob_with_model():
        """Test using `model` argument with custom Cob classes."""
        from databarn import Grain, create_child_cob_grain, create_child_barn_grain
    
        class Payload(Cob):
            model: str = Grain(required=True)
            temperature: float = Grain()
            max_tokens: int = Grain()
            reasoning_effort: str = Grain() # Reasoning effort is not supported in deepseek
            stream: bool = Grain(default=False)
    
            @create_child_cob_grain("response_format")
            class ResponseFormat(Cob):
                type: str = Grain("json_object")
    
            @create_child_barn_grain('messages')
            class Message(Cob):
                role: str = Grain(required=True)
                content: str = Grain(required=True)
    
        class Person(Cob):
            address: str = Grain()
    
            @create_child_cob_grain("natural")
            class Natural(Cob):
                first_name: str = Grain(required=True)
                last_name: str = Grain(required=True)
    
            @create_child_cob_grain("legal")
            class Legal(Cob):
                company_name: str = Grain(required=True)
                registration_number: str = Grain(required=True)
    
        # Test Payload
        payload_data = {
            "model": "gpt-4",
            "temperature": 0.7,
            "max_tokens": 100,
            "reasoning_effort": "high",
            # stream uses default
            "response_format": {"type": "text"},
            "messages": [
                {"role": "user", "content": "hello"},
                {"role": "assistant", "content": "hi"}
            ]
        }
    
>       payload = dict_to_cob(payload_data, model=Payload)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_funcs.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
databarn\funcs.py:212: in dict_to_cob
    outcome = _process_dict_if(value=value, model=model, label=label,
databarn\funcs.py:124: in _process_dict_if
    return Outcome(cobs_or_miscs, is_child_barn=True)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Outcome(new_value=<Unset>, is_child_barn_ref=<Unset>)
args = ([Message(role='user', content='hello'), Message(role='assistant', content='hi')],)
kwargs = {'is_child_barn': True}
dna = <databarn.dna.dna_factory.<locals>.Dna object at 0x00000156AC280B30>
seeds = (Seed(label='new_value', type=typing.Any, default=None, pk=False, required=False, auto=False, frozen=False, unique=Fal...lse, info=Info()), cob=Outcome(new_value=<Unset>, is_child_barn_ref=<Unset>), get_value()=<Unset>, has_been_set=False))
seed = Seed(label='new_value', type=typing.Any, default=None, pk=False, required=False, auto=False, frozen=False, unique=Fals...alse, info=Info()), cob=Outcome(new_value=<Unset>, is_child_barn_ref=<Unset>), get_value()=<Unset>, has_been_set=False)
argname_value_map = {'new_value': [Message(role='user', content='hello'), Message(role='assistant', content='hi')]}
index = 0, value = True
label_value_map = {'is_child_barn': True, 'new_value': [Message(role='user', content='hello'), Message(role='assistant', content='hi')]}
label = 'is_child_barn'

    def __init__(self, *args, **kwargs):
        """Initializes a Cob-like object.
    
        - Positional args are assigned to the grains in the order they were
        declared in the Cob-model (allowed only for static models).
        - Keyword args are assigned to the cob grains by name (allowed for both
        static and dynamic models).
        - If @create_child_barn_grain was applied, its factory() is set
        first, before any other assignment.
        - If a grain is not assigned a value, its default is assigned.
        - If a grain is assigned both positionally and as a keyword arg, an error
        is raised.
        - If a grain is assigned that is not defined in the model, an error is
        raised for static models, or a new grain is created for dynamic models.
    
        After all assignments, the `__post_init__` method is called, if defined.
    
        Args:
            *args: positional args to be assigned to grains
            **kwargs: keyword args to be assigned to grains
        """
        dna = self.__dna__(self)  # Create an object-level __dna__
        self.__dict__.update(__dna__=dna)  # Bypass __setattr__
    
        seeds = self.__dna__.seeds
    
        for seed in seeds:
            if seed.factory:
                setattr(self, seed.label, seed.factory())
    
        if self.__dna__.dynamic and args:
            raise DataBarnSyntaxError(fo(f"""
                Positional args cannot be provided to initialize
                '{type(self).__name__}' because no grain has been defined
                in the Cob-model. Use only keyword args to assign
                grain values dynamically."""))
        elif len(args) > len(seeds):
            raise DataBarnSyntaxError(fo(f"""
                Too many positional args provided to initialize
                '{type(self).__name__}'. Expected at most {len(seeds)},
                got {len(args)}."""))
    
        argname_value_map = {}
    
        # Static model assignment by position
        for index, value in enumerate(args):
            seed = seeds[index]
            if seed.label in kwargs:
                raise DataBarnSyntaxError(fo(f"""
                    Cannot assign value to grain '{arg_name}' both
                    positionally and as a keyword arg."""))
            argname_value_map[seed.label] = value
    
        label_value_map = argname_value_map | kwargs  # Merge dicts
    
        if not self.__dna__.dynamic:
            for label, value in label_value_map.items():
                if label not in self.__dna__.labels:
>                   raise StaticModelViolationError(fo(f"""
                        Cannot assign '{label}={value}' because the grain '{label}'
                        has not been defined in the Cob-model.
                        Since at least one grain has been defined in the Cob-model,
                        dynamic grain assignment is not allowed."""))
E                   databarn.exceptions.StaticModelViolationError: Cannot assign 'is_child_barn=True' because the grain 'is_child_barn' has not been defined in the Cob-model. Since at least one grain has been defined in the Cob-model, dynamic grain assignment is not allowed.

databarn\cob.py:95: StaticModelViolationError
=========================== short test summary info ===========================
FAILED tests/test_funcs.py::test_dict_to_cob_with_model - databarn.exceptions...
============================== 1 failed in 0.08s ==============================
